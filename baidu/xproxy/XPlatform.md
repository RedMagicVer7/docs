
#前端模板化与 后端服务化 实现技术 探讨#

##概述##

`前端模板化技术`是想实现`业务功能`的UI功能模板化的技术，这些UI是通用的，它可以快速复用于多个产品线中。

最近在部门内部对`前端模板化`技术做了些讨论，目前还集中在于业务端后端（服务化）如何去配合前端模板化技术的实施。

有兴趣的同学可以和我一起探讨。

**业务场景：**

通常情况下，为了在 业务平台上的某些业务功能，需要有以下三大模块：

- `前端模板`：N段JS及HTML代码集合，它们是功能的界面UI。对它来说，它需要请求后台服务来实现复杂的业务功能。
- `业务平台`：`业务平台`是展示业务功能的平台。`前端模板`在`业务平台`上展示。
- `X通用服务`：提供后台服务化的模块。

**目标：**

- `前端模板`：尽可能的通用化，可在多个 `业务平台` 上直接复用。
- `业务平台`：尽可能只作为`前端模板`和 `X通用服务` 的容器，`前端模板`的所有请求的实现均让`X通用服务`来完成。
- `X通用服务`：专注于提供专一的业务服务功能，它是统一的服务提供方。

以下是我们讨论出来的几种方案，值得注意的是，所有方案均抛弃了`跨域请求`技术，因为此种方案对浏览器有要求，并且会使`前端模板`代码复杂化。另外，我们可以通过Nginx的转发功能来轻松实现跨域请求功能。

## 方案 ##

###主方案一：业务接口平行化 ###

![](http://ww2.sinaimg.cn/bmiddle/60c9620fgw1ej42rnis6nj20gu09q3yu.jpg)

描述：`X通用服务`提供api jar包给 `业务平台`，`业务平台`接受 `前端模板`的API请求后，调用api jar包请求`X通用服务`。所谓接口平行化，就是指 `业务平台` 与`X通用服务`的接口数量 和 `业务平台`与`前端模板`的接口数量 是一样的。

###主方案二 业务接口隔离化：X通用服务反调 ###

![](http://ww3.sinaimg.cn/bmiddle/60c9620fgw1ej431a8sf8j20gp09j0t6.jpg)

描述：这是一种成熟的技术方案。`前端模板`通过Nginx转发来同域的调用`X通用服务`，`X通用服务`获取请求后，调用 `业务平台` 获取此请求相关的权限。

###主方案三 业务接口隔离化：token方案 ###

![](http://ww4.sinaimg.cn/bmiddle/60c9620fgw1ej431ynhl6j20gp09j3yy.jpg)

描述：`前端模板`还是通过Nginx转发来同域调用`X通用服务`，但是，在每次调用之前都先调用`业务平台`获取一个加密的TOken，`X通用服务`在接受到请求时，解密Token，验证此请求是否有权限。

###主方案四 业务接口隔离化：Proxy 方案 ###

![](http://ww4.sinaimg.cn/bmiddle/60c9620fgw1ej432u2jiqj20mr048aad.jpg)

描述：`前端模板`通过`业务平台`的转发功来发送请求给`X通用服务`。`业务平台`在转发的同时，又做了权限的功能。`业务平台`主要是做了本`业务平台`的权限功能。`X通用服务`的权限控制由它自己控制。

## 各种方案比较 ##

<table border="0" cellspacing="0" cellpadding="0">
  	<tr>
	    <th></th>
	    <th>业务接口平行化</th>
		<th>业务接口隔离化：`X通用服务`反调</th>
		<th>业务接口隔离化：token方案</th>
		<th>业务接口隔离化：Proxy 方案</th>
	</tr>
	<tr>
		<td width="150px"><b>多个主业务平台的情况下</b></td>
		<td width="150px">1.接口数量急剧增加，<br/> 2.每个`业务平台`的代码复制粘贴严重</td>
		<td width="150px">1.所有`业务平台`均需要额外提供RPC接口。<br/> 2.每添加一个`业务平台`，`X通用服务`均需要升级更改配置。</td>
		<td width="150px">所有`业务平台`需要提供一个Token的接口。</td>
		<td width="150px">所有`业务平台`需要实现一个转发的Filter或Interceptor。</td>
	</tr>
	<tr>
		<td width="150px"><b>优点</b></td>
		<td width="150px">简单粗暴</td>
		<td width="150px">1.技术成熟，有大量的实例验证。<br/>2.`X通用服务`选择灵活，可以自行控制权限，或者通过反调来控制权限。</td>
		<td width="150px">通过提供Token，避免了反调的方式。</td>
		<td width="150px">1.权限分开控制，`业务平台`负责自己的权限控制方案，`X通用服务`负责自己的权限控制方案。<br/>2.`业务平台`与`X通用服务`间解耦。</td>
	</tr>
	<tr>
		<td width="150px"><b>缺点</b></td>
		<td width="150px">1.开发量大，冗余代码量大，接口数量急剧增加。2.一旦接口发生变动，所有接入`X通用服务`的主业务平台均需要进行改动升级。<br/></td>
		<td width="150px">1.每增加一个`业务平台`，`X通用服务`均需要感知，耦合性增加。<br/>2.另外，多种控制权限的方法也会导致同个接口增加多种逻辑判断。</td>
		<td width="150px">`前端模板`需要两次调用，对`前端模板`的挑战较大</td>
		<td width="150px">1.技术较新，有挑战。<br/>2.由于`业务平台`做了些过滤功能，可能会限制了`X通用服务`未来扩展的灵活性。</td>
	</tr>
	<tr>
		<td width="150px"><b>适用场景</b></td>
		<td width="150px">1.`X通用服务`没有视图能力，例如检索端的KR服务。<br/>2.应该尽量避免此种使用，因为这样会造成后台难以维护。</td>
		<td width="150px">1.在本次讨论的`通用前端模板`的设计场景下比较不适合。<br/>2.它比较适合于`业务平台`URL跳转至`X通用服务`Web平台，`X通用服务`的权限控制又只能在主业务平台进行控制这种场景下。</td>
		<td width="150px">暂时不推荐（由于前端改变较大）</td>
		<td width="150px">1.比较适合于`业务平台`不是通过跳转到`X通用服务`来实现业务功能，而是采用`前端模板`JS来做业务功能这种场景。<br/>2.如果`X通用服务`的所有接口均可以通过Proxy来完成转发，可以考虑采用。如果`X通用服务`的多数接口都想自己来控制，那么Proxy方案就比较不适合了，可以退化成方案1.</td>
	</tr>
</table>

## 异步化方案的讨论 ##

前面所有的解决方案的 请求类型均是同步的。下面以上面的Proxy方案为基本，讨论一些异步场景的解决方案。

### 简单异步化：请求同步，数据异步 ###

描述：前端对`X通用服务`的数据操纵。这些数据的更新会影响到`业务平台`。

场景：删除`X通用服务`的一个转化后，需要通知`业务平台`的删除与该转化相关的关联数据。

![](http://ww4.sinaimg.cn/bmiddle/60c9620fgw1ej43gwg7ihj20mr0gkq3p.jpg)

解决方案：采用异步化方案。通过MQ将数据流打通，并使`X通用服务`与`业务平台`解耦。

### 复杂异步化：请求异步，数据异步  ###

描述：前端对`X通用服务`的数据操纵，此过程较“重”，并且操纵结果需要返回至前端展示。

场景：新建一个创意，`X通用服务`生成一个创意后，需要同步创意数据至`业务平台`，同步成功后，`X通用服务`将结果返回前端。

![](http://ww4.sinaimg.cn/bmiddle/60c9620fgw1ej43hx417kj20mr0gk757.jpg)

解决方案：完全异步化。前端请求后，`X通用服务`不返回结果。前端等待几秒后，继续请求。此时MQ已经将结果同步至`业务平台`，前端再次请求时，可以同步地返回正确处理结果。

## 关于通过跳转进行业务控制的理想解决方案##

上面讲到的是采用前端模板化方案。与此种方案对应的一种业务解决方案，是跳转。也就是说X通知平台将具有Web通力，`业务平台`想要实现某些业务功能，均通过跳转到`X通用服务`进行业务操作。

在这种场景下，一种理想的解决方案是：

![](http://ww2.sinaimg.cn/bmiddle/60c9620fgw1ej4389zl8dj20oe0mnjsl.jpg)

上面讲的方案二只是理想方案的妥协版。